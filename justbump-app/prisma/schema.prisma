generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model User {
  id                    Int       @id @default(autoincrement())
  email                 String    @unique @db.VarChar(255)
  phone_number          String?   @db.VarChar(20)
  password_hash         String    @db.VarChar(255)
  role                  UserRole  @default(User)
  email_verified        Boolean   @default(false) @db.TinyInt
  phone_number_verified Boolean   @default(false) @db.TinyInt
  failed_attempts       Int       @default(0)
  lockout_until         DateTime? @db.Timestamp(0)
  last_login            DateTime? @db.Timestamp(0)
  is_active             Boolean   @default(true) @db.TinyInt
  created_at            DateTime  @default(now()) @db.Timestamp(0)
  created_by            Int?
  updated_at            DateTime  @updatedAt @db.Timestamp(0)
  updated_by            Int?
  deleted_at            DateTime? @db.Timestamp(0)
  deleted_by            Int?

  // Self-relations for audit fields
  creator    User? @relation("CreatedByUser", fields: [created_by], references: [id], onDelete: SetNull)
  updater    User? @relation("UpdatedByUser", fields: [updated_by], references: [id], onDelete: SetNull)
  deleter    User? @relation("DeletedByUser", fields: [deleted_by], references: [id], onDelete: SetNull)
  createdUsers User[] @relation("CreatedByUser")
  updatedUsers User[] @relation("UpdatedByUser")
  deletedUsers User[] @relation("DeletedByUser")

  // Relations
  calling_card          CallingCard?
  created_cards         CallingCard[] @relation("CardCreatedBy")
  updated_cards         CallingCard[] @relation("CardUpdatedBy")
  deleted_cards         CallingCard[] @relation("CardDeletedBy")
  created_physical      PhysicalCard[] @relation("PhysicalCreatedBy")
  updated_physical      PhysicalCard[] @relation("PhysicalUpdatedBy")
  deleted_physical      PhysicalCard[] @relation("PhysicalDeletedBy")

  @@index([email], map: "idx_user_email")
  @@index([phone_number], map: "idx_user_phone")
  @@map("users")
}

enum UserRole {
  User
  Admin
}

model CallingCard {
  id                      Int       @id @default(autoincrement())
  user_id                 Int       @unique(map: "uq_calling_cards_user")
  full_name               String    @db.VarChar(100)
  job_title               String?   @db.VarChar(100)
  company                 String?   @db.VarChar(100)
  headline                String?   @db.VarChar(255)
  address                 String?   @db.Text
  profile_image_url       String?   @db.VarChar(512)
  bio_label               String?   @db.VarChar(50)
  bio_text                String?   @db.Text
  contact_value           String?   @db.VarChar(255)
  contact_action_type     ContactAction @default(both)
  bank_payment_provider   String?   @db.VarChar(100)
  bank_account_name       String?   @db.VarChar(100)
  bank_account_number     String?   @db.VarChar(50)
  bank_branch_code        String?   @db.VarChar(20)
  social_platform_name    String?   @db.VarChar(50)
  social_handle           String?   @db.VarChar(100)
  social_display_order    Int       @default(0)
  video_title             String?   @db.VarChar(100)
  video_source            String?   @db.Text
  video_description       String?   @db.Text
  video_display_order     Int       @default(0)
  external_link_label     String?   @db.VarChar(100)
  external_link_url       String?   @db.VarChar(512)
  external_link_display_order Int   @default(0)
  slug                    String    @unique @db.VarChar(50)
  sharing_id              String    @unique @db.Char(36)
  is_active               Boolean   @default(true) @db.TinyInt
  created_by              Int?
  updated_by              Int?
  deleted_at              DateTime? @db.Timestamp(0)
  deleted_by              Int?
  created_at              DateTime  @default(now()) @db.Timestamp(0)
  updated_at              DateTime  @updatedAt @db.Timestamp(0)

  // Relations
  user                    User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  creator                 User?     @relation("CardCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  updaterUser             User?     @relation("CardUpdatedBy", fields: [updated_by], references: [id], onDelete: SetNull)
  deleterUser             User?     @relation("CardDeletedBy", fields: [deleted_by], references: [id], onDelete: SetNull)
  physical_cards          PhysicalCard[]
  analytics               CardAnalytic[]

  @@map("calling_cards")
}

enum ContactAction {
  call
  message
  both
}

model PhysicalCard {
  card_id         Int       @id @default(autoincrement())
  card_uid        String    @unique(map: "uq_physical_cards_uid") @db.VarChar(100)
  card_type       String    @default("generic") @db.VarChar(50)
  created_by      Int?
  updated_by      Int?
  deleted_by      Int?
  calling_card_id Int?
  status          PhysicalCardStatus @default(unassigned)
  assigned_at     DateTime? @db.Timestamp(0)
  activated_at    DateTime? @db.Timestamp(0)
  created_at      DateTime  @default(now()) @db.Timestamp(0)
  updated_at      DateTime  @updatedAt @db.Timestamp(0)
  deleted_at      DateTime? @db.Timestamp(0)

  // Relations
  calling_card    CallingCard? @relation(fields: [calling_card_id], references: [id], onDelete: SetNull)
  creator         User?     @relation("PhysicalCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  updaterUser     User?     @relation("PhysicalUpdatedBy", fields: [updated_by], references: [id], onDelete: SetNull)
  deleterUser     User?     @relation("PhysicalDeletedBy", fields: [deleted_by], references: [id], onDelete: SetNull)

  @@index([created_by], map: "idx_physical_cards_created_by")
  @@index([updated_by], map: "idx_physical_cards_updated_by")
  @@index([deleted_by], map: "idx_physical_cards_deleted_by")
  @@index([calling_card_id], map: "idx_physical_cards_calling_card")
  @@map("physical_cards")
}

enum PhysicalCardStatus {
  unassigned
  assigned
  active
  blocked
}

model CardAnalytic {
  id         Int       @id @default(autoincrement())
  card_id    Int
  viewer_ip  String?   @db.VarChar(45)
  created_at DateTime  @default(now()) @db.Timestamp(0)
  updated_at DateTime  @updatedAt @db.Timestamp(0)
  deleted_at DateTime? @db.Timestamp(0)
  viewed_at  DateTime  @default(now()) @db.Timestamp(0)

  // Relations
  calling_card CallingCard @relation(fields: [card_id], references: [id], onDelete: Cascade)

  @@index([card_id], map: "idx_analytics_card")
  @@map("card_analytics")
}

